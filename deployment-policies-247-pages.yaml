# 247 Pages Launch - Deployment Policies & Security Configuration
# Victory36 Enterprise Security Framework
# Docker Image: sha256:8e88d79ceb64e375bdda77fa582bca8762aedbc463a9266c4a1b82363d655c3d

apiVersion: v1
kind: ConfigMap
metadata:
  name: deployment-policies-247-pages
  namespace: default
  labels:
    app: aixtiv-symphony
    version: v247
    security: victory36
data:
  # === DEPLOYMENT CONFIGURATION ===
  DEPLOYMENT_TARGET: "GCP_CLOUD_RUN"
  TOTAL_PAGES: "247"
  LAUNCH_ENVIRONMENT: "PRODUCTION"
  
  # === SECURITY POLICIES ===
  SECURITY_FRAMEWORK: "VICTORY36"
  ACCESS_CONTROL: "PUBLIC_PAGES"  # All 247 pages are open to public
  AUTHENTICATION: "NOT_REQUIRED"  # Public pages, no auth needed
  ENCRYPTION: "TLS_IN_TRANSIT"
  
  # === IMAGE SECURITY POLICIES ===
  CONTAINER_IMAGE: "sha256:8e88d79ceb64e375bdda77fa582bca8762aedbc463a9266c4a1b82363d655c3d"
  IMAGE_SCAN_REQUIRED: "true"
  VULNERABILITY_THRESHOLD: "CRITICAL_BLOCK"
  IMAGE_SIGNING: "VICTORY36_REQUIRED"
  
  # === NETWORK POLICIES ===
  NETWORK_ISOLATION: "VPC_TENANT_BOUNDARY"
  FIREWALL_RULES: "RESTRICTIVE"
  INGRESS_CONTROL: "CLOUD_LOAD_BALANCER_ONLY"
  EGRESS_CONTROL: "ALLOWLIST_ONLY"
  
  # === RESOURCE POLICIES ===
  CPU_LIMIT: "4000m"
  MEMORY_LIMIT: "8Gi"
  DISK_LIMIT: "50Gi"
  MAX_INSTANCES: "100"
  MIN_INSTANCES: "3"
  SCALING_POLICY: "AUTO_SCALE_HIGH_AVAILABILITY"
  
  # === DATA POLICIES ===
  DATA_RESIDENCY: "US_WEST1"
  BACKUP_POLICY: "MULTI_REGION"
  ENCRYPTION_AT_REST: "GOOGLE_MANAGED_KEYS"
  ENCRYPTION_IN_TRANSIT: "TLS_1_3_REQUIRED"
  
  # === MONITORING POLICIES ===
  MONITORING_ENABLED: "true"
  LOGGING_LEVEL: "INFO"
  METRICS_COLLECTION: "PROMETHEUS"
  ALERTING: "VICTORY36_SECURITY_ALERTS"
  HEALTH_CHECK_PATH: "/health"
  HEALTH_CHECK_INTERVAL: "30s"
  
  # === COMPLIANCE POLICIES ===
  COMPLIANCE_FRAMEWORK: "ENTERPRISE_GRADE"
  AUDIT_LOGGING: "REQUIRED"
  RETENTION_POLICY: "7_YEARS"
  GDPR_COMPLIANT: "true"
  SOC2_COMPLIANT: "true"

---
# === CLOUD RUN DEPLOYMENT POLICY ===
apiVersion: v1
kind: ConfigMap
metadata:
  name: cloud-run-deployment-247-pages
  labels:
    deployment: pages-247
    security: victory36
data:
  deployment-config.yaml: |
    # Cloud Run Deployment Configuration for 247 Pages
    service:
      name: aixtiv-symphony-247-pages
      image: gcr.io/api-for-warp-drive/aixtiv-symphony@sha256:8e88d79ceb64e375bdda77fa582bca8762aedbc463a9266c4a1b82363d655c3d
      region: us-west1
      platform: managed
      
    # Security Configuration
    security:
      allow-unauthenticated: true  # PUBLIC PAGES - No auth required
      ingress: all  # Open to public internet
      service-account: public-pages-service@api-for-warp-drive.iam.gserviceaccount.com
      
    # Resource Configuration  
    resources:
      cpu: "4"
      memory: "8Gi"
      max-instances: 100
      min-instances: 3
      concurrency: 1000
      timeout: 900s
      
    # Environment Variables
    environment:
      NODE_ENV: production
      GOOGLE_CLOUD_PROJECT: api-for-warp-drive
      PAGES_COUNT: "247"
      SECURITY_LEVEL: "VICTORY36_MAXIMUM"
      ACCESS_CONTROL: "PUBLIC_OPEN"
      PAGES_TYPE: "PUBLIC_WEBSITE"
      CDN_ENABLED: "true"
      CTA_ENDPOINT: "https://sallyport.2100.cool"
      FUNNEL_DESTINATION: "SALLYPORT_AUTHENTICATION"
      
    # Health Checks
    health_checks:
      liveness_probe:
        http_get:
          path: /health
          port: 8080
        initial_delay_seconds: 30
        period_seconds: 30
        timeout_seconds: 10
        failure_threshold: 3
        
      readiness_probe:
        http_get:
          path: /ready
          port: 8080
        initial_delay_seconds: 10
        period_seconds: 10
        timeout_seconds: 5
        failure_threshold: 3

---
# === SECURITY POLICIES FOR 247 PAGES ===
apiVersion: v1
kind: ConfigMap
metadata:
  name: security-policies-247-pages
  labels:
    security: victory36
    pages: "247"
data:
  security-policy.yaml: |
    # Victory36 Security Policies for 247 Pages Launch
    
    access_control:
      # PUBLIC PAGES - No Access Restrictions
      public_access:
        authentication: "NOT_REQUIRED"
        permissions: ["PUBLIC_READ_ACCESS"]
        page_access: "ALL_247_PAGES_PUBLIC"
        rate_limit: "10000_req_per_minute"  # Standard public rate limit
        caching: "CDN_ENABLED"
        seo_optimized: "true"
        mobile_friendly: "true"
        cta_buttons:
          destination: "https://sallyport.2100.cool"
          purpose: "AUTHENTICATION_FUNNEL"
          button_text: ["Get Started", "Sign In", "Access Dashboard", "Enter Console"]
          tracking: "ENABLED"
    
    # Network Security
    network_security:
      firewall_rules:
        - name: "allow-cloud-load-balancer"
          direction: "INGRESS"
          action: "allow"
          source_ranges: ["130.211.0.0/22", "35.191.0.0/16"]
          target_tags: ["aixtiv-symphony-247"]
          
        - name: "deny-direct-access"
          direction: "INGRESS" 
          action: "deny"
          source_ranges: ["0.0.0.0/0"]
          priority: 1000
          target_tags: ["aixtiv-symphony-247"]
          
        - name: "allow-vpc-internal"
          direction: "INGRESS"
          action: "allow"
          source_ranges: ["10.0.0.0/8"]
          target_tags: ["aixtiv-symphony-247"]
    
    # Data Protection
    data_protection:
      encryption_at_rest: "GOOGLE_MANAGED_ENCRYPTION"
      encryption_in_transit: "TLS_1_3_MINIMUM"
      data_classification: "ENTERPRISE_CONFIDENTIAL"
      backup_encryption: "CUSTOMER_MANAGED_ENCRYPTION"
      
    # Monitoring & Alerting
    monitoring:
      security_alerts:
        - name: "unauthorized_access_attempt"
          condition: "failed_auth_count > 10 in 5min"
          action: "BLOCK_IP_AND_ALERT"
          
        - name: "unusual_traffic_pattern"
          condition: "request_rate > 100x_baseline"
          action: "RATE_LIMIT_AND_INVESTIGATE"
          
        - name: "vulnerability_detected"
          condition: "container_scan_critical_found"
          action: "STOP_DEPLOYMENT_AND_ALERT"

---
# === DEPLOYMENT SCRIPT CONFIGURATION ===
apiVersion: v1
kind: ConfigMap
metadata:
  name: deployment-script-247-pages
data:
  deploy-247-pages.sh: |
    #!/bin/bash
    
    # 247 Pages Deployment Script with Victory36 Security
    set -euo pipefail
    
    # Configuration
    PROJECT_ID="api-for-warp-drive"
    REGION="us-west1"
    SERVICE_NAME="aixtiv-symphony-247-pages"
    IMAGE="gcr.io/${PROJECT_ID}/aixtiv-symphony@sha256:8e88d79ceb64e375bdda77fa582bca8762aedbc463a9266c4a1b82363d655c3d"
    
    echo "üöÄ Starting 247 Pages Deployment with Victory36 Security"
    echo "======================================================="
    
    # Pre-deployment Security Scan
    echo "üîç Running security scan on image..."
    gcloud container images scan $IMAGE \
      --remote \
      --format="table(vulnerability.effectiveSeverity,vulnerability.cvssScore,package,version)"
    
    # Deploy to Cloud Run with Security Policies
    echo "üì¶ Deploying to Cloud Run..."
    gcloud run deploy $SERVICE_NAME \
      --image=$IMAGE \
      --region=$REGION \
      --platform=managed \
      --no-allow-unauthenticated \
      --ingress=internal-and-cloud-load-balancing \
      --vpc-connector=projects/${PROJECT_ID}/locations/${REGION}/connectors/vpc-connector \
      --service-account=diamond-sao-service@${PROJECT_ID}.iam.gserviceaccount.com \
      --cpu=4 \
      --memory=8Gi \
      --max-instances=100 \
      --min-instances=3 \
      --concurrency=1000 \
      --timeout=900 \
      --set-env-vars="NODE_ENV=production,PAGES_COUNT=247,SECURITY_LEVEL=VICTORY36_MAXIMUM" \
      --port=8080 \
      --execution-environment=gen2
    
    # Apply IAM Policies
    echo "üîê Applying IAM policies..."
    gcloud run services add-iam-policy-binding $SERVICE_NAME \
      --region=$REGION \
      --member="user:pr@coaching2100.com" \
      --role="roles/run.invoker"
    
    # Configure Load Balancer
    echo "‚öñÔ∏è Configuring load balancer..."
    gcloud compute url-maps create ${SERVICE_NAME}-url-map \
      --default-service=${SERVICE_NAME}-backend-service || true
    
    # Set up monitoring
    echo "üìä Setting up monitoring..."
    gcloud logging sinks create ${SERVICE_NAME}-security-sink \
      bigquery.googleapis.com/projects/${PROJECT_ID}/datasets/security_logs \
      --log-filter='resource.type="cloud_run_revision" AND resource.labels.service_name="'${SERVICE_NAME}'"' || true
    
    # Final health check
    echo "üè• Running final health check..."
    SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --region=$REGION --format="value(status.url)")
    echo "Service deployed at: $SERVICE_URL"
    
    echo "‚úÖ 247 Pages deployment completed successfully!"
    echo "üõ°Ô∏è Victory36 security policies active"
    echo "üíé Gemstone access levels configured"
    
  health-check.sh: |
    #!/bin/bash
    
    # Health Check Script for 247 Pages
    SERVICE_NAME="aixtiv-symphony-247-pages"
    REGION="us-west1"
    
    echo "üè• Checking health of 247 pages deployment..."
    
    SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --region=$REGION --format="value(status.url)")
    
    # Check service health
    if curl -f -s "$SERVICE_URL/health" > /dev/null; then
      echo "‚úÖ Service health check: PASSED"
    else
      echo "‚ùå Service health check: FAILED"
      exit 1
    fi
    
    # Check page count
    PAGE_COUNT=$(curl -s "$SERVICE_URL/api/pages/count" | jq -r '.count' 2>/dev/null || echo "0")
    if [ "$PAGE_COUNT" = "247" ]; then
      echo "‚úÖ Page count verification: PASSED (247 pages)"
    else
      echo "‚ö†Ô∏è Page count verification: Expected 247, got $PAGE_COUNT"
    fi
    
    # Check security status
    SECURITY_STATUS=$(curl -s "$SERVICE_URL/api/security/status" | jq -r '.level' 2>/dev/null || echo "unknown")
    if [ "$SECURITY_STATUS" = "VICTORY36_MAXIMUM" ]; then
      echo "‚úÖ Security verification: PASSED (Victory36 Maximum)"
    else
      echo "‚ö†Ô∏è Security verification: Expected VICTORY36_MAXIMUM, got $SECURITY_STATUS"
    fi
    
    echo "üöÄ 247 Pages deployment health check complete!"