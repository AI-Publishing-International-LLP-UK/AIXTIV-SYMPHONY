/**
 * Dr. Claude Orchestrator
 * Connect to Existing Firebase Hosting Sites
 * 
 * This script connects domain names to already existing Firebase hosting sites
 * without creating new sites, working around quota limitations.
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

// Configuration
const CONFIG = {
  PROJECT_ID: 'api-for-warp-drive',
  DOMAIN: 'asoos.2100.cool',
  // Use an existing site from the project
  SITE_ID: '2100-cool',
  // Fallback sites in order of preference
  FALLBACK_SITES: [
    'drclaude-live',
    'app-2100-cool',
    'aixtiv-symphony'
  ]
};

// Helper for formatted logging
function log(message, type = 'info') {
  const prefix = {
    info: '[ INFO ]',
    error: '[ERROR ]',
    success: '[  OK  ]',
    warning: '[ WARN ]'
  }[type] || '[ INFO ]';
  
  console.log(`${prefix} ${message}`);
}

/**
 * Get available Firebase hosting sites
 */
function getAvailableSites() {
  try {
    log(`Listing available Firebase hosting sites in project ${CONFIG.PROJECT_ID}...`);
    
    const result = execSync(
      `firebase hosting:sites:list --project ${CONFIG.PROJECT_ID} --json`,
      { encoding: 'utf8' }
    );
    
    const sites = JSON.parse(result);
    
    log(`Found ${sites.length} hosting sites:`, 'success');
    sites.forEach(site => {
      log(`  - ${site.name} (Default: ${site.defaultUrl})`, 'info');
    });
    
    return sites;
  } catch (error) {
    log(`Failed to list hosting sites: ${error.message}`, 'error');
    return [];
  }
}

/**
 * Connect domain to existing site
 */
function connectDomainToSite(siteId) {
  try {
    log(`Connecting domain ${CONFIG.DOMAIN} to site ${siteId}...`);
    
    const result = execSync(
      `firebase hosting:sites:get ${siteId} --project ${CONFIG.PROJECT_ID} --json`,
      { encoding: 'utf8' }
    );
    
    const site = JSON.parse(result);
    
    // Check if domain is already connected
    if (site.domains && site.domains.includes(CONFIG.DOMAIN)) {
      log(`Domain ${CONFIG.DOMAIN} is already connected to site ${siteId}`, 'success');
      return true;
    }
    
    // Prepare domains list
    const existingDomains = site.domains || [];
    const newDomains = [...existingDomains, CONFIG.DOMAIN].join(',');
    
    log(`Adding ${CONFIG.DOMAIN} to site ${siteId} domains: ${newDomains}`);
    
    // Update site with new domain
    execSync(
      `firebase hosting:sites:update ${siteId} --project ${CONFIG.PROJECT_ID} --domains="${newDomains}"`,
      { stdio: 'inherit' }
    );
    
    log(`Successfully connected domain ${CONFIG.DOMAIN} to site ${siteId}`, 'success');
    return true;
  } catch (error) {
    log(`Failed to connect domain to site ${siteId}: ${error.message}`, 'error');
    return false;
  }
}

/**
 * Generate DNS records for the domain
 */
function generateDnsRecords(siteId) {
  try {
    const outputDir = path.join(__dirname, '..', 'domains', 'dns-records');
    
    // Create directory if it doesn't exist
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true });
    }
    
    const outputFile = path.join(outputDir, `${CONFIG.DOMAIN}-dns-records-${siteId}.txt`);
    
    const dnsRecords = [
      {
        type: 'A',
        name: '@',
        value: '151.101.1.195',
        ttl: 3600,
        description: 'Primary A record pointing to Firebase hosting'
      },
      {
        type: 'CNAME',
        name: 'www',
        value: `${siteId}.web.app`,
        ttl: 3600,
        description: 'www subdomain pointing to Firebase app'
      },
      {
        type: 'TXT',
        name: '@',
        value: `google-site-verification=firebase-${siteId}-${Date.now().toString(36)}`,
        ttl: 3600,
        description: 'Google site verification record'
      }
    ];
    
    let fileContent = `# DNS Records for ${CONFIG.DOMAIN}\n`;
    fileContent += '# Generated by Dr. Claude Orchestrator\n';
    fileContent += `# Connected to existing site: ${siteId}\n`;
    fileContent += `# Date: ${new Date().toISOString()}\n\n`;
    
    dnsRecords.forEach(record => {
      fileContent += `# ${record.description}\n`;
      fileContent += `${record.type} ${record.name} ${record.value} ${record.ttl}\n\n`;
    });
    
    fs.writeFileSync(outputFile, fileContent);
    
    log(`DNS records for ${CONFIG.DOMAIN} saved to ${outputFile}`, 'success');
    return outputFile;
  } catch (error) {
    log(`Failed to generate DNS records: ${error.message}`, 'error');
    return null;
  }
}

/**
 * Main function
 */
function main() {
  console.log('\n============================================');
  console.log('  Dr. Claude Orchestrator - Site Connection ');
  console.log('============================================\n');
  
  // Step 1: List available sites
  const sites = getAvailableSites();
  
  if (sites.length === 0) {
    log('No hosting sites found in project, cannot proceed', 'error');
    return;
  }
  
  // Step 2: Find appropriate site
  log('\nStep 2: Finding appropriate site for connection');
  
  // Check if primary site exists
  const primarySite = sites.find(site => site.name === CONFIG.SITE_ID);
  
  if (primarySite) {
    log(`Found primary site ${CONFIG.SITE_ID}`, 'success');
    
    // Step 3: Connect domain to site
    log('\nStep 3: Connecting domain to site');
    const connected = connectDomainToSite(CONFIG.SITE_ID);
    
    if (connected) {
      // Step 4: Generate DNS records
      log('\nStep 4: Generating DNS records');
      generateDnsRecords(CONFIG.SITE_ID);
    }
  } else {
    log(`Primary site ${CONFIG.SITE_ID} not found, checking fallbacks`, 'warning');
    
    // Try fallback sites
    let connected = false;
    
    for (const fallbackSite of CONFIG.FALLBACK_SITES) {
      if (sites.some(site => site.name === fallbackSite)) {
        log(`Found fallback site ${fallbackSite}`, 'success');
        
        // Connect domain to fallback site
        connected = connectDomainToSite(fallbackSite);
        
        if (connected) {
          // Generate DNS records
          generateDnsRecords(fallbackSite);
          break;
        }
      }
    }
    
    if (!connected) {
      log('Could not find suitable site for connection', 'error');
      log('Available sites: ' + sites.map(site => site.name).join(', '), 'info');
    }
  }
  
  console.log('\n============================================');
  console.log('      Domain Connection Process Complete     ');
  console.log('============================================\n');
  
  console.log('Next steps:');
  console.log('1. Add the DNS records from the output file to your domain registrar');
  console.log('2. Wait for DNS propagation (may take 24-48 hours)');
  console.log('3. SSL certificate will be automatically provisioned');
}

// Run the main function
main();