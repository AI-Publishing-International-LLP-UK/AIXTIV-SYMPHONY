name: Manage Service Accounts
on:
  workflow_dispatch:
  push:
    paths:
      - 'service-account-automation/**'
    branches:
      - main

jobs:
  setup-service-accounts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Google Cloud Auth
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform Init
        id: init
        run: |
          cd service-account-automation/terraform
          terraform init -input=false

      - name: Terraform Validate
        id: validate
        run: |
          cd service-account-automation/terraform
          terraform validate

      - name: Terraform Format Check
        id: fmt
        run: |
          cd service-account-automation/terraform
          terraform fmt -check

      - name: Terraform Plan
        id: plan
        run: |
          cd service-account-automation/terraform
          terraform plan -out=tfplan
        continue-on-error: false

      - name: Terraform Apply
        id: apply
        run: |
          cd service-account-automation/terraform
          terraform apply -auto-approve tfplan
        continue-on-error: false

      - name: Configure Regional Services
        id: regional
        run: |
          cd service-account-automation/terraform
          # Set up Pinecone in us-west1
          terraform apply -target=module.pinecone_us_west1 -auto-approve
          # Set up agents in us-west4 and us-central1
          terraform apply -target=module.agents_us_west4 -auto-approve
          terraform apply -target=module.agents_us_central1 -auto-approve

      - name: Upload Terraform Artifacts
        if: success() || failure()
        uses: actions/upload-artifact@v3
        with:
          name: terraform-outputs
          path: |
            service-account-automation/terraform/*.tfstate
            service-account-automation/terraform/.terraform.lock.hcl
            service-account-automation/terraform/.terraform/**

      - name: Generate Output Files
        id: outputs
        run: |
          cd service-account-automation/terraform
          terraform output -json > ../outputs/service-accounts.json
          jq -r 'to_entries[] | "\(.key)=\"\(.value)\""' ../outputs/service-accounts.json > ../outputs/.env

      - name: Upload Configuration Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: configuration-files
          path: service-account-automation/outputs/*

      - name: Clean up
        if: always()
        run: |
          rm -rf service-account-automation/terraform/.terraform
          rm -f service-account-automation/terraform/.terraform.lock.hcl

