# Integration Gateway Rate Limiting Configuration
# This file defines the rate limiting rules for the API gateway service

version: '1.0'
service: integration-gateway

# Global default rate limit settings
default_limits:
  requests_per_minute: 60
  requests_per_hour: 1000
  concurrent_requests: 10
  burst_multiplier: 2.0

# User tier-based rate limits
user_tiers:
  free:
    requests_per_minute: 30
    requests_per_hour: 500
    requests_per_day: 1000
    concurrent_requests: 5
  
  premium:
    requests_per_minute: 120
    requests_per_hour: 2000
    requests_per_day: 10000
    concurrent_requests: 20
  
  enterprise:
    requests_per_minute: 300
    requests_per_hour: 5000
    requests_per_day: 50000
    concurrent_requests: 50

# Endpoint-specific rate limits
endpoint_limits:
  # Authentication endpoints
  - path: "/api/v1/auth/*"
    methods: ["POST"]
    limits:
      requests_per_minute: 10
      requests_per_hour: 100
      requests_per_ip: 5
    exemptions:
      - user_type: "internal"
      - source_ip: "10.0.0.0/8"
  
  # Read-only data endpoints
  - path: "/api/v1/data/read/*"
    methods: ["GET"]
    limits:
      requests_per_minute: 100
      requests_per_hour: 1500
    tier_multipliers:
      free: 1.0
      premium: 3.0
      enterprise: 10.0
  
  # Data modification endpoints
  - path: "/api/v1/data/write/*"
    methods: ["POST", "PUT", "DELETE"]
    limits:
      requests_per_minute: 20
      requests_per_hour: 200
    tier_multipliers:
      free: 1.0
      premium: 5.0
      enterprise: 15.0

  # Batch processing endpoints
  - path: "/api/v1/batch/*"
    methods: ["POST"]
    limits:
      requests_per_minute: 5
      requests_per_hour: 50
      max_payload_size_mb: 10
    tier_multipliers:
      free: 0.5
      premium: 2.0
      enterprise: 10.0

# Special client API keys with custom limits
api_key_overrides:
  - key_prefix: "partner-"
    limits:
      requests_per_minute: 200
      requests_per_hour: 3000
  
  - key_prefix: "internal-"
    limits:
      requests_per_minute: 500
      requests_per_hour: 10000
      exempt_from_global: true

# Rate limiting response configuration
responses:
  rate_limited:
    status_code: 429
    headers:
      X-RateLimit-Limit: "{limit}"
      X-RateLimit-Remaining: "{remaining}"
      X-RateLimit-Reset: "{reset}"
    body_template: |
      {
        "error": "rate_limit_exceeded",
        "message": "Rate limit exceeded. Please try again in {retry_after} seconds.",
        "limit_type": "{limit_type}",
        "retry_after": "{retry_after}"
      }

# Advanced configuration
advanced:
  storage:
    type: "redis"
    expiration: 3600
  
  algorithms:
    type: "token_bucket"
    parameters:
      refill_rate: 1.0
      window_size_seconds: 60
  
  distributed:
    enabled: true
    sync_interval_ms: 100

# Monitoring and alerting
monitoring:
  log_level: "info"
  metrics_enabled: true
  alert_thresholds:
    global_rate_limit_percent: 80
    endpoint_rate_limit_percent: 90

