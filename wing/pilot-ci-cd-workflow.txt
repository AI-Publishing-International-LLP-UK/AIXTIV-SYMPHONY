name: AIXTIV Symphony CI/CD

on:
  push:
    branches: 
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  PROJECT_ID: api-for-warp-drive
  CLUSTER_NAME: aixtiv-symphony-primary
  REGION: us-west1

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Dependencies
      run: npm ci
    
    - name: Run Unit Tests
      run: npm run test:unit
    
    - name: Run Integration Tests
      run: npm run test:integration
    
    - name: Run Security Scan
      run: npm run security:scan

  build:
    name: Build and Push Docker Image
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
    
    - name: Configure Docker
      run: |
        gcloud auth configure-docker gcr.io
    
    - name: Build and Push Docker Image
      run: |
        docker build -t gcr.io/$PROJECT_ID/aixtiv-symphony:${{ github.sha }} .
        docker push gcr.io/$PROJECT_ID/aixtiv-symphony:${{ github.sha }}

  deploy:
    name: Deploy to Kubernetes
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v3
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
    
    - name: Set up Cloud SDK
      uses: google-cloud/setup-gcloud@v1
    
    - name: Configure kubectl
      run: |
        gcloud container clusters get-credentials $CLUSTER_NAME --region $REGION
    
    - name: Deploy to Kubernetes
      run: |
        # Update image in deployment
        kubectl set image deployment/aixtiv-symphony \
          aixtiv-symphony=gcr.io/$PROJECT_ID/aixtiv-symphony:${{ github.sha }} \
          -n production
        
        # Wait for rollout to complete
        kubectl rollout status deployment/aixtiv-symphony -n production

  notify:
    name: Deployment Notifications
    needs: [test, build, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Slack Notification
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
